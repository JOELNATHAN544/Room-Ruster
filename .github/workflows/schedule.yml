name: Weekly Room Roster Schedule

on:
  workflow_dispatch:
  schedule:
    - cron: "0 17 * * 0" # Every Sunday 17:00 UTC = 18:00 Cameroon time

jobs:
  send-weekly-schedule:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }} # Needed to push the file

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"

      - name: Build with Maven
        run: mvn -B clean package

      - name: Send roster only if it's a new week (STATEFUL + NO WEEK 48)
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          # === HARDCODED ANCHOR DATE: Week 1 = Monday 1 December 2025 ===
          ANCHOR_DATE="2025-12-01"

          # Read last posted week (or 0 if no file)
          if [ -f last-posted-week.txt ]; then
            LAST_WEEK=$(cat last-posted-week.txt)
            echo "Last posted week: $LAST_WEEK"
          else
            LAST_WEEK=0
            echo "First time running — starting from Week 1"
          fi

          # Calculate next Monday
          NEXT_MONDAY=$(date -d "next Monday" +%Y-%m-%d 2>/dev/null || python3 -c "import datetime; d = datetime.date.today(); print((d + datetime.timedelta(days=(7 - d.weekday()) % 7)).isoformat())")

          # Calculate current week number
          WEEKS_SINCE=$(echo $(($(date -d "$NEXT_MONDAY" +%s) - $(date -d "$ANCHOR_DATE" +%s))) / 604800 | bc)
          CURRENT_WEEK=$((WEEKS_SINCE + 1))

          echo "Next Monday: $NEXT_MONDAY"
          echo "Current week should be: $CURRENT_WEEK"

          # Only post if it's a NEW week
          if [ "$CURRENT_WEEK" -gt "$LAST_WEEK" ]; then
            echo "NEW WEEK! Posting Week $CURRENT_WEEK"
            java -jar target/room-ruster-0.1.0.jar --send

            # Save the new week number
            echo "$CURRENT_WEEK" > last-posted-week.txt
            git config user.name "Room Ruster Bot"
            git config user.email "bot@noreply.github.com"
            git add last-posted-week.txt
            git commit -m "Advance to Week $CURRENT_WEEK"
            git push
          else
            echo "Still Week $CURRENT_WEEK — already posted. Nothing to do."
          fi
