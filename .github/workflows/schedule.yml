name: Weekly Room Roster

on:
  # Test schedule - runs every minute starting at 09:10 UTC (10:10 AM CET)
  schedule:
    - cron: "*/1 9-23 * * *"

  # Manual trigger option (from GitHub UI)
  workflow_dispatch:

jobs:
  send:
    runs-on: ubuntu-latest
    permissions:
      contents: write # For committing the state file
      packages: read # For pulling the Docker image
      id-token: write # For GitHub OIDC token

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create state directory
        run: mkdir -p state

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.CR_PAT }} # Using the same PAT as in docker-build.yml

      - name: Pull and Run Docker Image
        run: |
          # Debug info
          echo "Current directory: $(pwd)"
          echo "Docker version: $(docker --version)"

          # Log in with the PAT
          echo ${{ secrets.CR_PAT }} | docker login ghcr.io -u ${{ github.actor }} --password-stdin

          # Pull the image with authentication
          echo "Pulling image..."
          docker pull ghcr.io/joelnathan544/room-ruster:latest

          # Create state directory if it doesn't exist
          mkdir -p state

          # Debug: Check if webhook URL is set
          echo "Webhook URL length: ${#DISCORD_WEBHOOK_URL}"
          
          # Run the container with the secret passed directly
          echo "Running container with webhook..."
          docker run --rm \
            -e "DISCORD_WEBHOOK_URL=${{ secrets.DISCORD_WEBHOOK_URL }}" \
            -e "GITHUB_ACTOR=${{ github.actor }}" \
            -v $(pwd)/state:/app/state \
            --entrypoint /bin/sh \
            ghcr.io/joelnathan544/room-ruster:latest -c "
              echo 'Environment variables in container:'
              env | grep -i discord
              java -jar room-ruster-0.1.0.jar --send
            "

          # Show state directory contents
          echo "State directory contents:"
          ls -la state/

          # Clean up
          rm -f .env

      - name: Commit and push updated state
        run: |
          git config user.name "Room-Ruster Bot"
          git config user.email "bot@room-ruster.local"
          git add state/last-posted-week.txt || echo "No changes to commit"
          git diff --quiet && git diff --staged --quiet || \
            (git commit -m "Update week state" && git push) || \
            echo "No changes to commit"
