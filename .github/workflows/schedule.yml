name: Weekly Room Roster Schedule

on:
  workflow_dispatch:
  schedule:
    - cron: "0 17 * * 0" # Every Sunday 17:00 UTC = 18:00 Cameroon

jobs:
  send-weekly-schedule:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: CLEAR OLD JAR (CRITICAL!)
        run: rm -rf ~/.m2/repository/com/roomruster || true

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"

      - name: Build with Maven (FRESH BUILD!)
        run: mvn -B clean package

      - name: Send roster only if it's a new week
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          ANCHOR_DATE="2025-12-01"

          if [ -f last-posted-week.txt ]; then
            LAST_WEEK=$(cat last-posted-week.txt)
          else
            LAST_WEEK=0
          fi

          NEXT_MONDAY=$(date -d "next Monday" +%Y-%m-%d 2>/dev/null || python3 -c "import datetime; d = datetime.date.today(); print((d + datetime.timedelta(days=(7 - d.weekday()) % 7)).isoformat())")
          WEEKS_SINCE=$(echo $(($(date -d "$NEXT_MONDAY" +%s) - $(date -d "$ANCHOR_DATE" +%s))) / 604800 | bc)
          CURRENT_WEEK=$((WEEKS_SINCE + 1))

          echo "Current week: $CURRENT_WEEK"

          if [ "$CURRENT_WEEK" -gt "$LAST_WEEK" ]; then
            echo "POSTING WEEK $CURRENT_WEEK"
            java -jar target/room-ruster-0.1.0.jar --send

            echo "$CURRENT_WEEK" > last-posted-week.txt
            git config user.name "Room Ruster Bot"
            git config user.email "bot@noreply.github.com"
            git add last-posted-week.txt
            git commit -m "Week $CURRENT_WEEK posted"
            git push
          else
            echo "Week $CURRENT_WEEK already posted â€” skipping"
          fi