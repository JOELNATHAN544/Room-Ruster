name: Weekly Room Roster

on:
  # Test schedule - runs at 09:41 UTC (10:41 AM CET)
  schedule:
    - cron: "41 9 * * *"
  
  # Manual trigger option (from GitHub UI)
  workflow_dispatch:

jobs:
  send:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # For committing the state file
      packages: read   # For pulling the Docker image
      
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Create state directory
        run: mkdir -p state
        
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull and Run Docker Image
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          # Debug info
          echo "Current directory: $(pwd)"
          echo "Docker version: $(docker --version)"
          
          # Pull the latest image with authentication
          echo ${{ secrets.GITHUB_TOKEN }} | docker login ghcr.io -u ${{ github.actor }} --password-stdin
          
          # Pull the image
          docker pull ghcr.io/joelnathan544/room-ruster:latest
          
          # Create a clean environment file
          echo "DISCORD_WEBHOOK_URL=$DISCORD_WEBHOOK_URL" > .env
          echo "GITHUB_ACTOR=${{ github.actor }}" >> .env
          
          # Run the container with proper environment and volume
          echo "Running container with DISCORD_WEBHOOK_URL"
          docker run --rm \
            --env-file .env \
            -v $(pwd)/state:/app/state \
            ghcr.io/joelnathan544/room-ruster:latest --send
          
          # Show state directory contents
          echo "State directory contents:"
          ls -la state/
          
          # Clean up
          rm -f .env

      - name: Commit and push updated state
        run: |
          git config user.name "Room-Ruster Bot"
          git config user.email "bot@room-ruster.local"
          git add state/last-posted-week.txt || echo "No changes to commit"
          git diff --quiet && git diff --staged --quiet || \
            (git commit -m "Update week state" && git push) || \
            echo "No changes to commit"
